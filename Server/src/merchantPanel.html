<HTML>
	<link rel="stylesheet" type="text/css" href="stylesheet.css" media="screen"/>
	<head>
	
	</head>
	<body>
		<p>Hello, world!</p>
		<input type="text" placeholder="Search..">
		<br>
		<button id="sticky1">Burrito</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<br>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		</br>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		</br>
		<button id="shoppingCartButton">Shopping Cart</button>
		</br>
		<iframe id="shoppingCartIFrame" src="shoppingCart.html"></iframe>
		
		<script>
			var shoppingCart = [];
			
			// https://stackoverflow.com/questions/9153445/how-to-communicate-between-iframe-and-the-parent-site
			function sendDataToIFrame(frameID,sentDataType,sentData) {
				/*var event = new CustomEvent("welborn_pushDataToFrame",{ data: sentData });
				var iframe = document.getElementById(frameID);
				iframe.contentWindow.dispatchEvent(event);*/
				var iframe = document.getElementById(frameID);
				iframe.contentWindow.postMessage({ dataType: sentDataType, data: sentData },"*");
			}
		
			function pushShoppingCartData() {
				sendDataToIFrame("shoppingCartIFrame","shoppingCartUpdate",shoppingCart);
			}
			
			function addToShoppingCart(item) {
				// If we can find the same item in the shopping cart, then just increment the amount
				for( [k, v] of Object.entries(shoppingCart) ) {
					if (v.UID == item.UID) {
						console.log(item.amount);
						v.amount = v.amount + item.amount;
						pushShoppingCartData();
						return;
					}
				}
				
				// If we didn't find an item of the same UID in the shopping cart, then go ahead and add it
				clonedItem = {
					"UID": item.UID,
					"displayName": item.displayName,
					"price": item.price,
					"amount": item.amount,
				}
				shoppingCart.push(clonedItem);
				pushShoppingCartData();
			}
			
			function removeFromShoppingCart(itemUID) {
				for( [k, v] of Object.entries(shoppingCart) ) {
					if (v.UID == itemUID) {
						shoppingCart.splice(k,1);
					}
				}
			}
			
			window.addEventListener("message",function(e) {
				if (e.data.dataType == "productSpinnerUpdate") {
					console.log("fantasy");
					var item = e.data.data;
					for( [k, v] of Object.entries(shoppingCart) ) {
						if (v.UID == item.UID) {
							v.amount = item.amount;
							console.log("Item UID "+v.UID+", "+v.displayName+" has updated its amount to "+v.amount+"!");
							
							if (v.amount <= 0) {
								console.log("Removing "+v.displayName+"!");
								removeFromShoppingCart(v.UID);
							}
							
							pushShoppingCartData();
							return;
						}
					}
				}
			})
			
			document.getElementById("shoppingCartIFrame").onload = function() {
				pushShoppingCartData();
			}
			
			var burrito = {
				"UID": 1,
				"displayName": "El Grande Chap Ay ay ay - burrito",
				"price": 4.99,
				"amount": 1,
			};
			
			document.getElementById("sticky1").onclick = function() {
				addToShoppingCart(burrito)
			}
		
			document.getElementById("shoppingCartButton").onclick = function() {
				var panel = document.getElementById("shoppingCartIFrame")
				if (panel.style.visibility == "visible") {
					panel.style.visibility = "hidden"
				} else {
					panel.style.visibility = "visible"
				}
			}
		</script>
	</body>
</HTML>