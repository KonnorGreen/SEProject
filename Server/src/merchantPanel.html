<HTML>
	<link rel="stylesheet" type="text/css" href="stylesheet.css" media="screen"/>
	<head>
		<meta charset="UTF-8">
	</head>
	<body>
		<p>Hello, world!</p>
		<input type="text" placeholder="Search..">
		<br>
		<button id="sticky1">Burrito</button>
		<button id="sticky2">Taco</button>
		<button id="sticky3">Nachos</button>
		<button id="sticky4">Sticky Item</button>
		<br>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		</br>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		<button>Sticky Item</button>
		
		</br>
		
		<button id="shoppingCartButton">Shopping Cart</button>
		
		</br>
		
		<div id="shoppingCartContainer" class="resizer">
			<iframe class="resized" id="shoppingCartIFrame" src="shoppingCart.html"></iframe>
		</div>
		
		<script>
			var shoppingCart = [];
			var shoppingCartUID = Math.floor(Math.random() * 100000000);
			
			// https://stackoverflow.com/questions/9153445/how-to-communicate-between-iframe-and-the-parent-site
			function sendDataToIFrame(frameID,sentDataType,sentData) {
				/*var event = new CustomEvent("welborn_pushDataToFrame",{ data: sentData });
				var iframe = document.getElementById(frameID);
				iframe.contentWindow.dispatchEvent(event);*/
				var iframe = document.getElementById(frameID);
				iframe.contentWindow.postMessage({ dataType: sentDataType, data: sentData },"*");
			}
		
			function pushShoppingCartData() {
				sendDataToIFrame("shoppingCartIFrame","shoppingCartUpdate",shoppingCart);
			}
			
			function addToShoppingCart(item) {
				// If we can find the same item in the shopping cart, then just increment the amount
				for( [k, v] of Object.entries(shoppingCart) ) {
					if (v.UID == item.UID) {
						console.log(item.amount);
						v.amount = v.amount + item.amount;
						pushShoppingCartData();
						return;
					}
				}
				
				// If we didn't find an item of the same UID in the shopping cart, then go ahead and add it
				clonedItem = {
					"UID": item.UID,
					"displayName": item.displayName,
					"price": item.price,
					"amount": item.amount,
				}
				shoppingCart.push(clonedItem);
				pushShoppingCartData();
			}
			
			function removeFromShoppingCart(itemUID) {
				for( [k, v] of Object.entries(shoppingCart) ) {
					if (v.UID == itemUID) {
						shoppingCart.splice(k,1);
					}
				}
			}
			
			window.addEventListener("message",function(e) {
				if (e.data.dataType == "productSpinnerUpdate") {
					var item = e.data.data;
					for( [k, v] of Object.entries(shoppingCart) ) {
						if (v.UID == item.UID) {
							v.amount = item.amount;
							console.log("Item UID "+v.UID+", "+v.displayName+" has updated its amount to "+v.amount+"!");
							
							if (v.amount <= 0) {
								console.log("Removing "+v.displayName+"!");
								removeFromShoppingCart(v.UID);
							}
							
							pushShoppingCartData();
							return;
						}
					}
				} else if(e.data.dataType == "eraseShoppingCart") {
					for( [k, v] of Object.entries(shoppingCart) ) {
						removeFromShoppingCart(v.UID);
					}
					pushShoppingCartData();
					document.getElementById("shoppingCartContainer").style.visibility = "hidden";
				} else if(e.data.dataType == "finalizeTransaction") {
					// Report to server
					editedShoppingCart = {};
					for( [k, v] of Object.entries(shoppingCart) ) {
						editedShoppingCart[k] = {
							"a":"a"
						}
					}
					
					const http = new XMLHttpRequest();
					var url = "/finalizetransaction";
					url = url + "?shoppingCartUID="+shoppingCartUID+"&phoneNumber="+e.data.data.phoneNumber+"&transactionType="+e.data.data.transactionType;
					http.open("POST",url);
					http.send(JSON.stringify(shoppingCart));
					
					for( [k, v] of Object.entries(shoppingCart) ) {
						removeFromShoppingCart(v.UID);
					}
					pushShoppingCartData();
					document.getElementById("shoppingCartContainer").style.visibility = "hidden";
					shoppingCartUID = Math.floor(Math.random() * 100000000);
				}
			})
			
			document.getElementById("shoppingCartIFrame").onload = function() {
				pushShoppingCartData();
			}
			
			var burrito = {
				"UID": 1,
				"displayName": "El Grande Burrito",
				"price": 4.99,
				"amount": 1,
			};
			
			var taco = {
				"UID": 2,
				"displayName": "Big Spicy Taco",
				"price": 6.99,
				"amount": 1,
			};
			
			var nacho = {
				"UID": 3,
				"displayName": "Drippy Cheesy Nachos",
				"price": 5.99,
				"amount": 1,
			};
			
			document.getElementById("sticky1").onclick = function() {
				addToShoppingCart(burrito)
				document.getElementById("shoppingCartContainer").style.visibility = "visible";
			}
			
			document.getElementById("sticky2").onclick = function() {
				addToShoppingCart(taco)
				document.getElementById("shoppingCartContainer").style.visibility = "visible";
			}
			
			document.getElementById("sticky3").onclick = function() {
				addToShoppingCart(nacho)
				document.getElementById("shoppingCartContainer").style.visibility = "visible";
			}
		
			document.getElementById("shoppingCartButton").onclick = function() {
				var panel = document.getElementById("shoppingCartContainer")
				if (panel.style.visibility == "visible") {
					panel.style.visibility = "hidden"
				} else {
					panel.style.visibility = "visible"
				}
			}
		</script>
	</body>
</HTML>